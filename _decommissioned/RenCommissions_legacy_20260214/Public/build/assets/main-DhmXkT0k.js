const d=new Map;function S(){console.log("[RenCommissions] Initializing cart button injection..."),w().then(()=>{console.log("[RenCommissions] POS cart found, starting observation..."),P()}).catch(e=>{console.warn("[RenCommissions] POS cart not found after waiting:",e)})}function w(){return new Promise((e,o)=>{let t=0;const n=30,s=setInterval(()=>{t++;const r=document.querySelector("#pos-cart")||document.querySelector(".ns-pos-cart")||document.querySelector("#cart-products-table")||document.querySelector('[id*="cart"]');r?(clearInterval(s),e(r)):t>=n&&(clearInterval(s),o(new Error("POS cart not found")))},1e3)})}function P(){const e=document.querySelector("#pos-cart")||document.querySelector("#cart-products-table")||document.body;if(!e){console.warn("[RenCommissions] Cart container not found");return}const o=new MutationObserver(t=>{window.__rcProcessing||(clearTimeout(o._debounceTimer),o._debounceTimer=setTimeout(()=>{f()},150))});o.observe(e,{childList:!0,subtree:!0}),setTimeout(()=>f(),500),console.log("[RenCommissions] MutationObserver started")}function f(){const e=document.querySelectorAll(".product-item, [product-index]");e.length!==0&&e.forEach((o,t)=>{const n=l(t),s=(n==null?void 0:n.product_id)||(n==null?void 0:n.id),r=s?d.has(s):!1,i=o.querySelector(".rencommissions-btn");if(i){C(i,r,t);return}const c=o.querySelector(".product-options")||o.querySelector(".flex.product-options")||o.querySelector(".product-details > div:last-child");if(!c){const a=o.querySelector(".product-controls .flex")||o.querySelector(".product-controls");a&&y(a,t,r);return}y(c,t,r)})}function C(e,o,t){e.dataset.productIndex=String(t),e.style.pointerEvents="auto",e.innerHTML=o?'<i class="las la-check-circle text-xl" style="pointer-events:none"></i>':'<i class="las la-hand-holding-usd text-xl" style="pointer-events:none"></i>',o?(e.className="rencommissions-btn cursor-pointer outline-hidden border-dashed py-1 border-b border-success-secondary text-success-secondary hover:text-success-tertiary text-sm",e.title=__("Commission Assigned")):(e.className="rencommissions-btn cursor-pointer outline-hidden border-dashed py-1 border-b border-info-secondary text-info-secondary hover:text-info-tertiary text-sm",e.title=__("Assign Commission"));const n=e;n._rcHandler||(n._rcHandler=!0,n.addEventListener("mousedown",b,!1))}function y(e,o,t=!1){if(e.querySelector(".rencommissions-btn"))return;const n=document.createElement("div");n.className="px-1";const s=document.createElement("a");s.className=t?"rencommissions-btn cursor-pointer outline-hidden border-dashed py-1 border-b border-success-secondary text-success-secondary hover:text-success-tertiary text-sm":"rencommissions-btn cursor-pointer outline-hidden border-dashed py-1 border-b border-info-secondary text-info-secondary hover:text-info-tertiary text-sm",s.style.pointerEvents="auto",s.title=t?__("Commission Assigned"):__("Assign Commission"),s.innerHTML=t?'<i class="las la-check-circle text-xl" style="pointer-events:none"></i>':'<i class="las la-hand-holding-usd text-xl" style="pointer-events:none"></i>',s.dataset.productIndex=String(o),s._rcHandler=!0,s.addEventListener("mousedown",b,!1),n.appendChild(s),e.appendChild(n)}function b(e){if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),window.__rcProcessing)return;window.__rcProcessing=!0;const o=e.currentTarget,t=parseInt(o.dataset.productIndex||"0",10);console.log("[RenCommissions] Button clicked, product index:",t),setTimeout(()=>{window.__rcProcessing=!1},100),v(t)}async function v(e){console.log("[RenCommissions] Commission button clicked for product index:",e);const o=l(e);if(!o){nsSnackBar.error(__("Could not retrieve product information"));return}x(o)}function l(e){try{if(typeof POS<"u"&&POS.products){let o=[];if(typeof POS.products.getValue=="function"?o=POS.products.getValue():Array.isArray(POS.products)&&(o=POS.products),console.log("[RenCommissions] POS products:",o.map((t,n)=>({index:n,id:t.id,product_id:t.product_id,name:t.name}))),o&&o[e]){const t=o[e];return console.log("[RenCommissions] Selected product at index",e,":",{id:t.id,product_id:t.product_id,name:t.name}),{id:t.id,product_id:t.product_id,name:t.name,product_name:t.name,unit_price:t.unit_price,quantity:t.quantity,barcode:t.barcode}}}return h(e)}catch(o){return console.error("[RenCommissions] Error getting product from state:",o),h(e)}}function h(e){var u,m,p;const t=document.querySelectorAll(".product-item, [product-index]")[e];if(!t)return null;const n=t.querySelector("h3, .font-semibold, .product-name"),s=((m=(u=n==null?void 0:n.textContent)==null?void 0:u.trim().split("â€”")[0])==null?void 0:m.trim())||`Product ${e+1}`,r=t.querySelector('[class*="price"], a[class*="cursor-pointer"]');let i=0;if(r){const _=(r.textContent||"").match(/[\d,.]+/);_&&(i=parseFloat(_[0].replace(/,/g,""))||0)}const c=t.querySelector('.border-dashed.border-secondary.p-2, [class*="quantity"]');let a=1;return c&&(a=parseFloat(((p=c.textContent)==null?void 0:p.trim())||"1")||1),{id:e,product_id:void 0,name:s,product_name:s,unit_price:i,quantity:a}}async function x(e){try{const[o,t]=await Promise.all([g("/api/rencommissions/earners"),g("/api/rencommissions/types")]),n=o.data||o||[],s=t.data||t||[];if(n.length===0){nsSnackBar.error(__("No eligible earners found"));return}if(s.length===0){nsSnackBar.error(__("No commission types configured"));return}const r=await q(n);if(!r)return;const i=await T(s);if(!i)return;const c=await R(e,r,i);if(!c||!await k(e,r,i,c))return;await I(e,r,i,c)}catch(o){console.error("[RenCommissions] Error in popup:",o),nsSnackBar.error(o.message||__("Failed to assign commission"))}}function g(e){return new Promise((o,t)=>{nsHttpClient.get(e).subscribe({next:n=>o(n),error:n=>t(n)})})}function q(e){return new Promise(o=>{Popup.show(nsSelectPopup,{label:__("Select Earner"),description:__("Choose who will receive the commission"),options:e.map(t=>({label:t.display_name||t.username,value:t.id})),resolve:t=>{const n=e.find(s=>s.id===t);o(n||null)},reject:()=>o(null)})})}function T(e){return new Promise(o=>{Popup.show(nsSelectPopup,{label:__("Select Commission Type"),description:__("Choose the commission calculation method"),options:e.map(t=>({label:`${t.name} (${B(t)})`,value:t.id})),resolve:t=>{const n=e.find(s=>s.id===t);o(n||null)},reject:()=>o(null)})})}function B(e){switch(e.calculation_method){case"percentage":return`${e.default_value}%`;case"fixed":return __("Fixed");case"on_the_house":return __("On The House");default:return String(e.default_value)}}async function R(e,o,t){return new Promise(n=>{nsHttpClient.post("/api/rencommissions/preview",{product_id:e.product_id||e.id,commission_type:t.calculation_method,unit_price:e.unit_price,quantity:e.quantity||1,commission_value:t.default_value}).subscribe({next:s=>n(s.data||s),error:s=>{console.error("[RenCommissions] Preview error:",s),nsSnackBar.error(s.message||__("Failed to calculate commission")),n(null)}})})}function k(e,o,t,n){return new Promise(s=>{const r=e.name||e.product_name||"Product",i=o.display_name||o.username,c=n.total_commission||n.commission_per_unit||"0",a=`${__("Assign commission of")} ${c} ${__("to")} ${i} ${__("for")} ${r}?`;Popup.show(nsConfirmPopup,{title:__("Confirm Commission"),message:a,onAction:u=>s(u)})})}async function I(e,o,t,n){return new Promise((s,r)=>{const i=e.product_id||e.id||0;console.log("[RenCommissions] Assigning commission:",{product_raw:e,product_product_id:e.product_id,product_id_field:e.id,resolved_productId:i}),nsHttpClient.post("/api/rencommissions/session/assign",{product_index:i,product_id:i,staff_id:o.id,commission_type:t.calculation_method,unit_price:e.unit_price,quantity:e.quantity||1,commission_value:n.rate||t.default_value}).subscribe({next:c=>{nsSnackBar.success(c.message||__("Commission assigned successfully")),d.set(i,{earner_id:o.id,earner_name:o.display_name||o.username,commission_type:t.calculation_method,amount:n.total_commission||0}),O(),s()},error:c=>{nsSnackBar.error(c.message||__("Failed to assign commission")),r(c)}})})}function O(){document.querySelectorAll(".product-item, [product-index]").forEach((o,t)=>{const n=l(t),s=(n==null?void 0:n.product_id)||(n==null?void 0:n.id),r=s?d.has(s):!1,i=o.querySelector(".rencommissions-btn");i&&C(i,r,t)})}document.addEventListener("DOMContentLoaded",()=>{S()});
